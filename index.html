<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Synoptique GSO Sud</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: Arial, sans-serif;
    }
    #topbar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 50px; background: #b30000;
      color: #fff; display: flex;
      align-items: center; justify-content: center;
      font-size: 1.2rem; font-weight: bold;
      z-index: 1001;
    }
    #content {
      position: absolute; top: 50px; bottom: 50px;
      left: 0; right: 0;
    }
    #map, #casernesList, #interventionsList {
      width: 100%; height: 100%;
    }
    #casernesList, #interventionsList {
      display: none; overflow-y: auto;
      background: #f9f9f9;
    }
    #bottombar {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 50px; display: flex;
    }
    #bottombar button {
      flex: 1; border: none;
      background: #e0e0e0; color: #555;
      font-size: 1rem; cursor: pointer;
    }
    #bottombar button.active {
      background: #ccc;
    }
    .station-item,
    .intervention-item {
      padding: 10px; border-bottom: 1px solid #ccc;
      background: #fff; font-weight: bold;
      cursor: pointer;
    }
    .station-item:hover,
    .intervention-item:hover { background: #eee; }
    .synoptic, .interv-synoptic {
      padding: 10px 0 20px 0;
      background: #fafafa;
    }
    .hidden { display: none; }
    .category-section { margin: 20px 15px; }
    .category-title {
      color: #b30000;
      font-size: 1.1em;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .vehicles-row {
      display: flex; flex-wrap: wrap; gap: 6px;
      padding-left: 10px;
    }
    .vehicle {
      padding: 6px 10px; border-radius: 6px;
      font-size: 0.9em; font-weight: bold;
      cursor: pointer;
    }
    .DM { background: #d3d3d3; color: #000; }
    .IN { background: #000;    color: #fff; }
    .DL { background: #90ee90; color: #000; }
    .RE { background: #006400; color: #fff; }
    .AL { background: #ffeb3b; color: #d32f2f; }
    .PA { background: #d32f2f; color: #fff; }
    .SL { background: #d32f2f; color: #000; }
    .TH { background: #fff;    color: #5c6bc0; }
    .AH { background: #fff;    color: #000; }
    .PC { background: #fff;    color: #388e3c; }
    .QH { background: #fff;    color: #ff9800; }
    .RD { background: #5c6bc0; color: #000; }
    .RI { background: #5c6bc0; color: #fff; }
    .MD { background: #9c27b0; color: #000; }
    .MI { background: #9c27b0; color: #fff; }
    .RV { background: #ff9800; color: #000; }
    .default { background: #d3d3d3; color: #000; }
    .leaflet-popup-content a {
      color: inherit;
      text-decoration: none;
    }
    @media (max-width:600px) {
      .vehicle { font-size: 0.8em; }
      .category-title { font-size: 1em; }
    }
  </style>
</head>
<body>

  <div id="topbar">Synoptique GSO Sud</div>

  <div id="content">
    <div id="map"></div>
    <div id="casernesList"></div>
    <div id="interventionsList"></div>
  </div>

  <div id="bottombar">
    <button id="btnMap" class="active">Carte</button>
    <button id="btnInterventions">Interventions</button>
    <button id="btnCasernes">Casernes</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // 1) Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyCe6_BM4BtT0fi6-yudBOAMIkPueq2rKYA",
      authDomain: "cis-sdmis.firebaseapp.com",
      databaseURL: "https://cis-sdmis-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cis-sdmis",
      storageBucket: "cis-sdmis.appspot.com",
      messagingSenderId: "305775040783",
      appId: "1:305775040783:web:28abe37dc830d2e3ab067a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2) DOM refs
    const mapDiv           = document.getElementById('map');
    const casernesDiv      = document.getElementById('casernesList');
    const intervsDiv       = document.getElementById('interventionsList');
    const btnMap           = document.getElementById('btnMap');
    const btnCasernes      = document.getElementById('btnCasernes');
    const btnInterventions = document.getElementById('btnInterventions');

    // 3) Stations & categories
    const stations = [
      { nom:"Ampuis",          lat:45.48889,      lng:4.81179 },
      { nom:"Chasse-sur-Rhône",lat:45.5854485617, lng:4.8043075387 },
      { nom:"Condrieu",        lat:45.46453,      lng:4.76837 },
      { nom:"Sainte-Colombe",  lat:45.52468,      lng:4.86382 },
      { nom:"Vienne",          lat:45.5368644486, lng:4.8733135671 }
    ];
    const categories = {
      "Secours à Personne":["VLINF 01","VSAV 01","VSAV 02"],
      "Incendie":["CCFM 01","CCI 01","FPTASR 01","FPTL 01"],
      "Echelle":["EPS24 01"],
      "Opérations Diverses":["VFI 01","VFIHR 01","VTUTP 01"],
      "Commandement":["VLCDG 01"],
      "Remorque Cellule Lot":[
        "BMS 01","LBACHE 01","LBALIS 01","LCITS5 01",
        "LDEPOL 01","LDNROY 01","LECLE 01","LELEC 01",
        "LGAZ 01","LTRON 01","MPR 01","R2BLS 01"
      ]
    };
    const categoriesVienne = {
      "Secours à Personne":["VSAV 01","VSAV 02","VSAV 03"],
      "Incendie":["FPT 01","FPTL 51","CCFM 01","CCGC 01","DA 01"],
      "Echelle":["EPS 01"],
      "Secours Routiers":["FSR 51"],
      "Opérations Diverses":["VL 01","VL 02","VLHR 01","VTUE 01"],
      "Risques Chimiques":["FIRT 01"],
      "Secours Nautiques":["BMS 01","BPS 01","VSA 01"]
    };
    const categoriesChasse = {
      "Secours à Personne":["VSAV 01"],
      "Incendie":["CCRMSR 01"],
      "Opérations Diverses":["VL 01","VTUE 01"]
    };

    //  statut → classe CSS
    function getStatusClass(s) {
      const st = String(s||'').trim().toUpperCase();
      return ["DL","RE","AL","PA","SL","TH","AH","PC","QH","RD","RI","MD","MI","IN","DM","RV"]
        .includes(st) ? st : 'default';
    }

    // 4) Data trackers
    const stationData    = {}, stationRefs    = {}, stationMarkers    = {};
    const centreData     = {}, centreRefs     = {};
    const engagedMap     = {};  // clé "Station_CODE" → id intervention
    const interventionMarkersRhône = {}, interventionMarkersIsere = {};

    stations.forEach(s=>{
      if (s.nom==="Vienne"||s.nom==="Chasse-sur-Rhône") {
        centreRefs[s.nom] = db.ref(`Isère/Centre/${s.nom}`);
        centreRefs[s.nom].on('value', snap=>{
          centreData[s.nom] = snap.val()||{};
          updateIcon(s.nom);
        });
      } else {
        stationRefs[s.nom] = db.ref(`CIS/${s.nom}/Engins`);
        stationRefs[s.nom].on('value', snap=>{
          stationData[s.nom] = snap.val()||{};
          updateIcon(s.nom);
        });
      }
    });

    // 5) Station icons
    function makeStationIcon(color) {
      return L.divIcon({
        html: `<svg viewBox="0 0 64 64" width="32" height="32" xmlns="http://www.w3.org/2000/svg">
                 <rect x="8" y="16" width="48" height="32" fill="${color}" stroke="#333" stroke-width="2"/>
                 <rect x="16" y="32" width="16" height="16" fill="#fff" stroke="#333" stroke-width="1"/>
                 <line x1="16" y1="36" x2="32" y2="36" stroke="#333" stroke-width="1"/>
                 <line x1="16" y1="40" x2="32" y2="40" stroke="#333" stroke-width="1"/>
                 <line x1="16" y1="44" x2="32" y2="44" stroke="#333" stroke-width="1"/>
                 <rect x="22" y="20" width="6" height="4" fill="#fff" stroke="#333" stroke-width="1"/>
                 <rect x="29" y="20" width="6" height="4" fill="#fff" stroke="#333" stroke-width="1"/>
                 <rect x="36" y="20" width="6" height="4" fill="#fff" stroke="#333" stroke-width="1"/>
                 <rect x="48" y="28" width="8" height="12" fill="#ccc" stroke="#333" stroke-width="1"/>
               </svg>`,
        className:'', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]
      });
    }
    const iconRed    = makeStationIcon('#b30000');
    const iconOrange = makeStationIcon('#ff9800');
    const iconGreen  = makeStationIcon('#00aa00');

    function updateDefaultIcon(name) {
      const data = stationData[name]||{};
      const down = Object.entries(data)
        .filter(([_,st])=>st.trim().toUpperCase()==='DL')
        .map(([n])=>n);
      let ic = iconRed;
      if (down.length>1 && down.some(v=>v.startsWith('VSAV'))) ic = iconGreen;
      else if (down.length>1) ic = iconOrange;
      stationMarkers[name]?.setIcon(ic);
    }
    function updateVienneIcon() {
      const d = centreData['Vienne']||{};
      const vs = ['VSAV 01','VSAV 02','VSAV 03']
        .map(c=> (d[c]||'').toUpperCase());
      const anyAvail = vs.some(s=>['DL','RD'].includes(s));
      if (anyAvail) {
        stationMarkers['Vienne']?.setIcon(iconGreen);
      } else {
        const [en,di] = (d['Personnel']||'0/0').split('/').map(n=>parseInt(n,10));
        const avail = di - en;
        if (avail < 3)      stationMarkers['Vienne']?.setIcon(iconRed);
        else                 stationMarkers['Vienne']?.setIcon(iconOrange);
      }
    }
    function updateChasseIcon() {
      const st = (centreData['Chasse-sur-Rhône']?.['VSAV 01']||'').toUpperCase();
      const engaged = !['DL','RD'].includes(st);
      stationMarkers['Chasse-sur-Rhône']
        ?.setIcon(engaged ? iconRed : iconOrange);
    }
    function updateIcon(name) {
      if (name==='Vienne')              updateVienneIcon();
      else if (name==='Chasse-sur-Rhône') updateChasseIcon();
      else                               updateDefaultIcon(name);
    }

    // 6 Intervention icons
function makeItvIconRhône(id) {
  return L.divIcon({
    html: `
      <div style="
        position: relative;
        display: inline-block;
        text-align: center;
        overflow: visible;
      ">
        <div style="
          position: absolute;
          top: -0.8em;
          left: 50%;
          transform: translateX(-50%);
          font-size: 0.8em;
          font-weight: bold;
          color: #000;
          white-space: nowrap;
        ">
          N°${id}
        </div>
        <svg viewBox="0 0 32 42" width="32" height="42"
             xmlns="http://www.w3.org/2000/svg">
          <path d="M16,0 C23.7,0 30,6.3 30,14
                   C30,24.8 16,42 16,42
                   C16,42 2,24.8 2,14
                   C2,6.3 8.3,0 16,0 Z"
                fill="#003366"/>
          <text x="16" y="25" text-anchor="middle"
                fill="#fff" font-size="22" font-weight="bold">!</text>
        </svg>
      </div>`,
    className:   '',
    iconSize:    [32, 42],
    iconAnchor:  [16, 42],
    popupAnchor: [0, -40]
  });
}

    // remplace exactement cette partie
function makeItvIconIsere(id) {
  return L.divIcon({
    html: `
      <div style="
        position: relative;
        display: inline-block;
        text-align: center;
        overflow: visible;
      ">
        <div style="
          position: absolute;
          top: -0.8em;
          left: 50%;
          transform: translateX(-50%);
          font-size: 0.8em;
          font-weight: bold;
          color: #000;
          white-space: nowrap;
        ">
          N°${id}
        </div>
        <svg viewBox="0 0 32 42" width="32" height="42"
             xmlns="http://www.w3.org/2000/svg">
          <path d="M16,0 C23.7,0 30,6.3 30,14
                   C30,24.8 16,42 16,42
                   C16,42 2,24.8 2,14
                   C2,6.3 8.3,0 16,0 Z"
                fill="#ff9800"/>
          <text x="16" y="25" text-anchor="middle"
                fill="#fff" font-size="22" font-weight="bold">!</text>
        </svg>
      </div>`,
    className:   '',
    iconSize:    [32, 42],
    iconAnchor:  [16, 42],
    popupAnchor: [0, -40]
  });
}


    // 7) Tab management
    function showTab(tab) {
      mapDiv.style.display      =
      casernesDiv.style.display =
      intervsDiv.style.display  = 'none';
      btnMap.classList.remove('active');
      btnCasernes.classList.remove('active');
      btnInterventions.classList.remove('active');
      if (tab==='map') {
        mapDiv.style.display = 'block';
        btnMap.classList.add('active');
        setTimeout(()=> map.invalidateSize(), 200);
      }
      if (tab==='casernes') {
        casernesDiv.style.display = 'block';
        btnCasernes.classList.add('active');
      }
      if (tab==='interventions') {
        intervsDiv.style.display = 'block';
        btnInterventions.classList.add('active');
      }
    }

    // 8) Helpers for cross-navigation
    function openCaserne(name) {
      showTab('casernes');
      const item = casernesDiv.querySelector(`.station-item[data-name="${name}"]`);
      if (item) { item.scrollIntoView({behavior:'smooth',block:'center'}); item.click(); }
    }
    function openIntervention(id) {
      showTab('interventions');
      const item = intervsDiv.querySelector(`.intervention-item[data-id="${id}"]`);
      if (item) { item.scrollIntoView({behavior:'smooth',block:'center'}); item.click(); }
    }
    function openIntervOnMap(id) {
      showTab('map');
      const mrk = interventionMarkersIsere[id] || interventionMarkersRhône[id];
      if (mrk) {
        map.setView(mrk.getLatLng(), map.getZoom());
        mrk.openPopup();
      }
    }

    // 9) Init map & markers
    let map;
    function initMap() {
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'© OpenStreetMap contributors'
      }).addTo(map);

      stations.forEach(s=>{
        const link = `<a href="#" class="popup-caserne" data-name="${s.nom}">CT ${s.nom}</a>`;
        const m = L.marker([s.lat,s.lng], {icon:iconRed})
          .addTo(map).bindPopup(link);
        stationMarkers[s.nom] = m;
      });

      // Rhône interventions
      db.ref('Interventions').on('child_added', snap=>{
        const id  = snap.key, itv = snap.val()||{};
        if (interventionMarkersRhône[id]) return;
        const lat = parseFloat(itv.gps?.lng),
              lng = parseFloat(itv.gps?.lat);
        if (isNaN(lat)||isNaN(lng)) return;
        const mrk = L.marker([lat,lng], {icon:makeItvIconRhône()}).addTo(map);
        interventionMarkersRhône[id] = mrk;

        // engager map
        Object.values(itv.vehicules||{}).forEach(fn=>{
          const parts = fn.trim().split(' ');
          const code   = parts.slice(0,parts.length-1).join(' ');
          const station= parts[parts.length-1];
          engagedMap[`${station}_${code}`] = id;
        });

// 1) on prépare le HTML du popup (avec <a class="popup-interv" …>)
const popupHtml =
  `<a href="#" class="popup-interv" data-id="${id}">
     <strong>${itv.dhDebutInter||''} - ${itv.sinistreCourant||''}</strong>
   </a>
   <p>${addr}</p>`;
mrk.bindPopup(popupHtml);

// 2) à chaque clic on rouvre simplement la popup
mrk.on('click', () => mrk.openPopup());


      });

      // Isère interventions
      db.ref('Isère/Interventions').on('child_added', snap=>{
        const id  = snap.key, itv = snap.val()||{};
        if (interventionMarkersIsere[id]) return;
        const addr = itv.Adresse||'';
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`)
          .then(r=>r.json()).then(res=>{
            if (!res.length) return;
            const lat = parseFloat(res[0].lat),
                  lon = parseFloat(res[0].lon);
            const mrk = L.marker([lat,lon], {icon:makeItvIconIsere(id)}).addTo(map);
            interventionMarkersIsere[id] = mrk;

            // build engagedMap
            db.ref(`Isère/Interventions/${id}/Engins`)
              .once('value').then(esnap=>{
              const engs = esnap.val()||{};
              Object.values(engs).forEach(val => {
  // val ex: "VSAV 01 VIENNE SL" ou "VIT 52 CH VIENNE"
  const parts  = val.trim().split(' ');
  const status = parts.pop() || 'DL';          // toujours le dernier mot
  const centre = parts.pop();                  // avant-dernier
  const code   = parts.join(' ');              // tout ce qui reste
  if (!groups[centre]) groups[centre] = [];
  groups[centre].push({ code, status });
});

            });

        // 1) bindPopup une seule fois avec le contenu dynamique
const popupContent = 
  `<a href="#" class="popup-interv" data-id="${id}">
      <strong>${itv.dhDebutInter||''} - ${itv.sinistreCourant||''}</strong>
   </a>
   <p>${addr}</p>`;
mrk.bindPopup(popupContent);

// 2) à chaque clic on rouvre
mrk.on('click', () => {
  mrk.openPopup();
});


          }).catch(console.warn);
      });

      // popup cross-links
      map.on('popupopen', e=>{
        const el = e.popup.getElement();
        const linkC = el.querySelector('.popup-caserne');
        if (linkC) {
          linkC.onclick = ev=>{
            ev.preventDefault();
            openCaserne(linkC.dataset.name);
          };
        }
        const linkI = el.querySelector('.popup-interv');
        if (linkI) {
          linkI.onclick = ev=>{
            ev.preventDefault();
            openIntervention(linkI.dataset.id);
          };
        }
      });

      map.fitBounds(
        L.latLngBounds(stations.map(s=>[s.lat,s.lng])),
        { padding:[50,50] }
      );
    }

    // 10) Casernes list
    function initCasernesList() {
      stations.slice().sort((a,b)=>a.nom.localeCompare(b.nom))
        .forEach(s=>{
          const item = document.createElement('div');
          item.className    = 'station-item';
          item.textContent  = s.nom;
          item.dataset.name = s.nom;
          casernesDiv.appendChild(item);

          const syn = document.createElement('div');
          syn.className = 'synoptic hidden';
          casernesDiv.appendChild(syn);

          item.onclick = ()=> {
            if (syn.classList.contains('hidden')) {
              syn.innerHTML = '';
              let cats, dataObj;
              if (s.nom==='Condrieu') {
                cats    = categories;
                dataObj = stationData['Condrieu']||{};
              } else if (s.nom==='Vienne') {
                cats    = categoriesVienne;
                dataObj = centreData['Vienne']||{};
              } else if (s.nom==='Chasse-sur-Rhône') {
                cats    = categoriesChasse;
                dataObj = centreData['Chasse-sur-Rhône']||{};
              } else {
                cats    = { "Secours à Personne":["VSAV 01"] };
                dataObj = stationData[s.nom]||{};
              }
              Object.entries(cats).forEach(([cat,list])=>{
                const sec   = document.createElement('div');
                sec.className = 'category-section';
                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = cat;
                sec.appendChild(title);
                const row   = document.createElement('div');
                row.className = 'vehicles-row';
                list.forEach(name=>{
                  const st  = (dataObj[name]||'').trim();
                  const cls = getStatusClass(st);
                  const v   = document.createElement('div');
                  v.className   = `vehicle ${cls}`;
                  v.textContent = name;
                  row.appendChild(v);
                });
                sec.appendChild(row);
                syn.appendChild(sec);
              });
              syn.classList.remove('hidden');
            } else {
              syn.classList.add('hidden');
            }
          };
        });
    }

    // 11) Construire la liste des interventions (Rhône + Isère)
    function subscribeInterventionsList() {
      intervsDiv.innerHTML = ''; // vider à chaque initialisation

      // 11a) Rhône
      db.ref('Interventions').orderByChild('createdAt')
        .on('child_added', snap => {
          const id   = snap.key;
          const itv  = snap.val() || {};
          const time = itv.createdAt || '';
          const motif= itv.motif    || '';

          // Élément résumé
          const item = document.createElement('div');
          item.className  = 'intervention-item';
          item.dataset.id = id;
          item.innerHTML  = `<strong>${time} - ${motif} (${id})</strong>`;

          // Détails cachés
          const syn = document.createElement('div');
          syn.className = 'interv-synoptic hidden';

          item.addEventListener('click', () => {
            if (syn.classList.contains('hidden')) {
              // Pas d'adresse Rhône, on affiche juste les engins
              syn.innerHTML = '';
              syn.appendChild(document.createElement('p')).textContent = 'Engins engagés :';
              const row = document.createElement('div');
              row.className = 'vehicles-row';

              const vehs = Object.values(itv.vehicules || {});
              // grouper par centre
              const grouped = {};
              vehs.forEach(fn => {
                const parts   = fn.trim().split(' ');
                const station = parts.pop();
                const code    = parts.join(' ');
                if (!grouped[station]) grouped[station] = [];
                grouped[station].push(code);
              });
              Object.entries(grouped).forEach(([station, codes]) => {
                const v = document.createElement('div');
                v.className   = 'vehicle default';
                v.textContent = `${station} : ${codes.join(' ')}`;
                row.appendChild(v);
              });

              syn.appendChild(row);
              syn.classList.remove('hidden');
            } else {
              syn.classList.add('hidden');
            }
          });

          intervsDiv.append(item, syn);
        });

  // … juste avant, tu as déjà vidé intervsDiv et géré le Rhône

  // 11b) Isère
  db.ref('Isère/Interventions').orderByChild('dhDebutInter')
    .on('child_added', snap => {
      const id      = snap.key;
      const itv     = snap.val() || {};
      const time    = itv.dhDebutInter    || '';
      const motif   = itv.sinistreCourant || '';
      const address = itv.Adresse        || '';
      const engs    = itv.Engins         || {};

      // résumé cliquable
      const item = document.createElement('div');
      item.className  = 'intervention-item';
      item.dataset.id = id;
      item.innerHTML  = `<strong>${time} - ${motif}</strong>`;

      // détails cachés
      const syn = document.createElement('div');
      syn.className = 'interv-synoptic hidden';

      item.addEventListener('click', () => {
        // injecte le contenu **une** fois
        if (!syn._init) {
          syn.innerHTML = '';
          // adresse
          const pAddr = document.createElement('p');
          pAddr.textContent = address;
          syn.appendChild(pAddr);

          // titre engins
          const pTitle = document.createElement('p');
          pTitle.textContent = 'Engins engagés :';
          syn.appendChild(pTitle);

          // grouper par centre
          const groups = {};
          Object.values(engs).forEach(val => {
            // val ex: "VSAV 01 VIENNE SL"
            const parts = val.trim().split(' ');
            const status  = parts.pop() || 'DL';       // dernier élément
            const centre  = parts.pop();               // avant-dernier
            const code    = parts.join(' ');           // le reste
            if (!groups[centre]) groups[centre] = [];
            groups[centre].push({ code, status });
          });

          // affichage
          Object.entries(groups).forEach(([centre, vehs]) => {
            // 1 ligne titre centre (sans statut)
            const h = document.createElement('div');
            h.textContent    = centre + ' :';
            h.style.margin   = '8px 0 4px';
            h.style.fontWeight = 'bold';
            syn.appendChild(h);

            // 1 ligne de badges
            const row = document.createElement('div');
            row.className = 'vehicles-row';
            vehs.forEach(({ code, status }) => {
              const v = document.createElement('div');
              v.className   = 'vehicle ' + getStatusClass(status);
              v.textContent = code;
              row.appendChild(v);
            });
            syn.appendChild(row);
          });

          syn._init = true;
        }
        syn.classList.toggle('hidden');
      });

      intervsDiv.append(item, syn);
    });
  }

    // 12) Clic sur badge d'engin dans "Caserne" → bascule vers la carte
    casernesDiv.addEventListener('click', e => {
      const el = e.target.closest('.vehicle');
      if (!el) return;
      e.stopPropagation();
      const code = el.textContent.split(' : ').pop().trim();
      const stationName = el.textContent.split(' : ')[0].trim();
      const id = engagedMap[`${stationName}_${code}`];
      if (id) openIntervOnMap(id);
    });

    // 13) Bottombar & navigation croisée
    btnMap.addEventListener('click',        () => showTab('map'));
    btnInterventions.addEventListener('click', () => showTab('interventions'));
    btnCasernes.addEventListener('click',   () => showTab('casernes'));

    // 14) Au chargement de la page
    window.addEventListener('DOMContentLoaded', () => {
      initMap();
      initCasernesList();
      subscribeInterventionsList();
      showTab('map');
    });
  </script>
</body>
</html>
 ```
