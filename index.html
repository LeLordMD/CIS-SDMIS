<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Synoptique GSO Sud</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: Arial, sans-serif;
    }
    #topbar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 50px; background: #b30000;
      color: #fff; display: flex;
      align-items: center; justify-content: center;
      font-size: 1.2rem; font-weight: bold;
      z-index: 1001;
    }
    #content {
      position: absolute; top: 50px; bottom: 50px;
      left: 0; right: 0;
    }
    #map, #casernesList, #interventionsList {
      width: 100%; height: 100%;
    }
    #casernesList, #interventionsList {
      display: none; overflow-y: auto;
      background: #f9f9f9;
    }
    #bottombar {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 50px; display: flex;
    }
    #bottombar button {
      flex: 1; border: none;
      background: #e0e0e0; color: #555;
      font-size: 1rem; cursor: pointer;
    }
    #bottombar button.active {
      background: #ccc;
    }
    .station-item,
    .intervention-item {
      padding: 10px; border-bottom: 1px solid #ccc;
      background: #fff; font-weight: bold;
      cursor: pointer;
    }
    .station-item:hover,
    .intervention-item:hover { background: #eee; }
    .synoptic, .interv-synoptic {
      padding: 10px 0 20px 0;
      background: #fafafa;
    }
    .hidden { display: none; }
    .category-section { margin: 20px 15px; }
    .category-title {
      color: #b30000;
      font-size: 1.1em;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .vehicles-row {
      display: flex; flex-wrap: wrap; gap: 6px;
      padding-left: 10px;
    }
    .vehicle {
      padding: 6px 10px; border-radius: 6px;
      font-size: 0.9em; font-weight: bold;
      cursor: pointer;
    }
    /* carte popup dynamique */
    .interv-detail {
      display: flex; justify-content: space-between;
      align-items: flex-start; margin-bottom: 8px;
      padding: 0 10px;
    }
    .default { background: #d3d3d3; color: #000; }
    .DL { background: #90ee90; color: #000; }
    .RE { background: #006400; color: #000; }
    .AL { background: #ffeb3b; color: #d32f2f; }
    .PA { background: #d32f2f; color: #fff; }
    .SL { background: #d32f2f; color: #000; }
    .TH { background: #fff;    color: #5c6bc0; }
    .AH { background: #fff;    color: #000; }
    .PC { background: #fff;    color: #388e3c; }
    .QH { background: #fff;    color: #ff9800; }
    .RD { background: #5c6bc0; color: #000; }
    .RI { background: #5c6bc0; color: #fff; }
    .MD { background: #9c27b0; color: #000; }
    .MI { background: #9c27b0; color: #fff; }
    .IN { background: #000;    color: #fff; }
    .DM { background: #d3d3d3; color: #000; }
    .RV { background: #ff9800; color: #000; }
    .TR { background: #363636; color: #fff; }
    .ID { background: #ffeb3b; color: #000; }
    .leaflet-popup-content a {
      color: inherit;
      text-decoration: none;
    }
    @media (max-width:600px) {
      .vehicle { font-size: 0.8em; }
      .category-title { font-size: 1em; }
    }
  </style>
</head>
<body>

  <div id="topbar">Synoptique GSO Sud</div>

  <div id="content">
    <div id="map"></div>
    <div id="casernesList"></div>
    <div id="interventionsList"></div>
  </div>

  <div id="bottombar">
    <button id="btnMap" class="active">Carte</button>
    <button id="btnInterventions">Interventions</button>
    <button id="btnCasernes">Casernes</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // 1) Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyCe6_BM4BtT0fi6-yudBOAMIkPueq2rKYA",
      authDomain: "cis-sdmis.firebaseapp.com",
      databaseURL: "https://cis-sdmis-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cis-sdmis",
      storageBucket: "cis-sdmis.appspot.com",
      messagingSenderId: "305775040783",
      appId: "1:305775040783:web:28abe37dc830d2e3ab067a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2) DOM refs
    const mapDiv           = document.getElementById('map');
    const casernesDiv      = document.getElementById('casernesList');
    const intervsDiv       = document.getElementById('interventionsList');
    const btnMap           = document.getElementById('btnMap');
    const btnCasernes      = document.getElementById('btnCasernes');
    const btnInterventions = document.getElementById('btnInterventions');

    // 3) Stations & categories
    const stations = [
      { nom:"Ampuis",          lat:45.48889,      lng:4.81179 },
      { nom:"Chasse-sur-Rhône",lat:45.5854485617, lng:4.8043075387 },
      { nom:"Condrieu",        lat:45.46453,      lng:4.76837 },
      { nom:"Sainte-Colombe",  lat:45.52468,      lng:4.86382 },
      { nom:"Vienne",          lat:45.5368644486, lng:4.8733135671 }
    ];
    const categories = {
      "Secours à Personne":["VLINF 01","VSAV 01","VSAV 02"],
      "Incendie":["CCFM 01","CCI 01","FPTASR 01","FPTL 01"],
      "Echelle":["EPS24 01"],
      "Opérations Diverses":["VFI 01","VFIHR 01","VTUTP 01"],
      "Commandement":["VLCDG 01"],
      "Secours Nautiques":["BMS 01", "R2BLS 01","LDEPOL 01"],
      "Remorque Cellule Lot":[
        "LBACHE 01","LBALIS 01","LCITS5 01",
        "LDNROY 01","LECLE 01","LELEC 01",
        "LGAZ 01","LTRON 01","MPR 01"
      ]
    };
    const categoriesVienne = {
      "Secours à Personne":["VSAV 01","VSAV 02","VSAV 03"],
      "Incendie":["FPT 01","FPTL 51","CCF4 01","CCGC 01","DA 01"],
      "Echelle":["EPS 01"],
      "Secours Routiers":["FSR 51"],
      "Opérations Diverses":["VL 01","VL 02","VLTTC 01","VTUE 01"],
      "Risques Chimiques":["FIRT 01"],
      "Secours Nautiques":["BMS 01","BPS 01","VSA 01"]
    };
    const categoriesChasse = {
      "Secours à Personne":["VSAV 01"],
      "Incendie":["CCRMSR 01"],
      "Opérations Diverses":["VL 01","VTUE 01"]
    };

    function getStatusClass(s) {
      const st = String(s||'').trim().toUpperCase();
      return ["DL","RE","AL","PA","SL","TH","AH",
              "PC","QH","RD","RI","MD","MI","IN",
              "DM","RV", "TR", "ID"].includes(st) ? st : 'default';
    }

    // 4) Data trackers
const stationData    = {}, stationRefs    = {}, stationMarkers    = {};
const centreData     = {}, centreRefs     = {};
const engagedMap     = {}; // clé: "Centre_Engin" -> itvId
const interventionMarkersRhône = {}, interventionMarkersIsere = {};
const interventionDataRhône = {}; // stocke la payload complète par id
const interventionDataIsere  = {}; // idem pour Isère

// helper : remplir engagedMap depuis Isère/Interventions/[id]/Engins Engagés
function fillEngagedMapFromIsere(id, engOrdered) {
  Object.keys(engOrdered).sort((a,b)=>parseInt(a,10)-parseInt(b,10)).forEach(orderKey => {
    const centresObj = engOrdered[orderKey] || {};
    Object.entries(centresObj).forEach(([centreName, enginsObj]) => {
      Object.keys(enginsObj || {}).forEach(enginName => {
        const displayCentre = (String(centreName) === 'Ste-Colombe') ? 'Sainte-Colombe' : centreName;
        engagedMap[`${displayCentre}_${enginName}`] = id;
      });
    });
  });
}

// attach realtime listeners for station nodes (supports updates, removals)
stations.forEach(s=>{
  if (s.nom==="Vienne"||s.nom==="Chasse-sur-Rhône") {
    centreRefs[s.nom] = db.ref(`Isère/Centre/${s.nom}`);
    centreRefs[s.nom].on('value', snap=>{
      centreData[s.nom] = snap.val()||{};
      updateIcon(s.nom);
      refreshCaserneSynoptic(s.nom);
    });
  } else {
    const path = (s.nom === 'Sainte-Colombe') ? 'CIS/Ste-Colombe/Engins' : `CIS/${s.nom}/Engins`;
    stationRefs[s.nom] = db.ref(path);

    // value listener keeps stationData up-to-date and triggers UI refreshes
    stationRefs[s.nom].on('value', snap => {
      stationData[s.nom] = snap.val() || {};
      updateIcon(s.nom);
      refreshCaserneSynoptic(s.nom);
      // if any engagedMap entries depend on this station, force UI refresh of interventions list and popups
      refreshAllInterventionPopups();
      refreshInterventionsListOpenItems();
    });
  }
});

    // 5) Station icons
    function makeStationIcon(color) {
      return L.divIcon({
        html: `<svg viewBox="0 0 64 64" width="32" height="32"
                     xmlns="http://www.w3.org/2000/svg">
                 <rect x="8" y="16" width="48" height="32"
                       fill="${color}" stroke="#333" stroke-width="2"/>
                 <rect x="16" y="32" width="16" height="16"
                       fill="#fff" stroke="#333" stroke-width="1"/>
                 <line x1="16" y1="36" x2="32" y2="36"
                       stroke="#333" stroke-width="1"/>
                 <line x1="16" y1="40" x2="32" y2="40"
                       stroke="#333" stroke-width="1"/>
                 <line x1="16" y1="44" x2="32" y2="44"
                       stroke="#333" stroke-width="1"/>
                 <rect x="22" y="20" width="6" height="4"
                       fill="#fff" stroke="#333" stroke-width="1"/>
                 <rect x="29" y="20" width="6" height="4"
                       fill="#fff" stroke="#333" stroke-width="1"/>
                 <rect x="36" y="20" width="6" height="4"
                       fill="#fff" stroke="#333" stroke-width="1"/>
                 <rect x="48" y="28" width="8" height="12"
                       fill="#ccc" stroke="#333" stroke-width="1"/>
               </svg>`,
        className:'', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]
      });
    }
    const iconRed    = makeStationIcon('#b30000');
    const iconOrange = makeStationIcon('#ff9800');
    const iconGreen  = makeStationIcon('#00aa00');

    function updateDefaultIcon(name) {
      const data = stationData[name]||{};
      const down = Object.entries(data)
        .filter(([_,st])=>st.trim().toUpperCase()==='DL')
        .map(([n])=>n);
      let ic = iconRed;
      if (down.length>1 && down.some(v=>v.startsWith('VSAV'))) ic = iconGreen;
      else if (down.length>1)                   ic = iconOrange;
      stationMarkers[name]?.setIcon(ic);
    }
    function updateVienneIcon() {
      const d  = centreData['Vienne']||{};
      const vs = ['VSAV 01','VSAV 02','VSAV 03']
        .map(c=> (d[c]||'').toUpperCase());
      const anyAvail = vs.some(s=>['DL','RD'].includes(s));
      if (anyAvail) {
        stationMarkers['Vienne']?.setIcon(iconGreen);
      } else {
        const [en,di] = (d['Personnel']||'0/0')
          .split('/').map(n=>parseInt(n,10));
        const avail = di - en;
        stationMarkers['Vienne']
          ?.setIcon(avail < 3 ? iconRed : iconOrange);
      }
    }
    function updateChasseIcon() {
      const st = (centreData['Chasse-sur-Rhône']?.['VSAV 01']||'')
        .toUpperCase();
      const engaged = !['DL','RD'].includes(st);
      stationMarkers['Chasse-sur-Rhône']
        ?.setIcon(engaged ? iconRed : iconOrange);
    }
    function updateIcon(name) {
      if (name==='Vienne')                 updateVienneIcon();
      else if (name==='Chasse-sur-Rhône') updateChasseIcon();
      else                                 updateDefaultIcon(name);
    }

    // 6) Intervention icons
    function makeItvIconRhône() {
      const svg = `<svg viewBox="0 0 32 42" width="32" height="42"
                       xmlns="http://www.w3.org/2000/svg">
                     <path d="M16,0 C23.7,0 30,6.3 30,14 C30,24.8 16,42 16,42
                              C16,42 2,24.8 2,14 C2,6.3 8.3,0 16,0 Z"
                           fill="#003366"/>
                     <text x="16" y="25" text-anchor="middle"
                           fill="#fff" font-size="22" font-weight="bold">!</text>
                   </svg>`;
      return L.divIcon({
        html: svg, className:'', iconSize:[32,42],
        iconAnchor:[16,42], popupAnchor:[0,-40]
      });
    }
    function makeItvIconIsere(id) {
      return L.divIcon({
        html: `
          <div style="
            position: relative;
            display: inline-block;
            text-align: center;
            overflow: visible;
          ">
            <div style="
              position: absolute;
              top: -0.8em;
              left: 50%;
              transform: translateX(-50%);
              font-size: 0.8em;
              font-weight: bold;
              color: #000;
              white-space: nowrap;
            ">
              N°${id}
            </div>
            <svg viewBox="0 0 32 42" width="32" height="42"
                 xmlns="http://www.w3.org/2000/svg">
              <path d="M16,0 C23.7,0 30,6.3 30,14
                       C30,24.8 16,42 16,42
                       C16,42 2,24.8 2,14
                       C2,6.3 8.3,0 16,0 Z"
                    fill="#ff9800"/>
              <text x="16" y="25" text-anchor="middle"
                    fill="#fff" font-size="22" font-weight="bold">!</text>
            </svg>
          </div>`,
        className:'', iconSize:[32,42],
        iconAnchor:[16,42], popupAnchor:[0,-40]
      });
    }

    // 7) Tab management
    function showTab(tab) {
      mapDiv.style.display      =
      casernesDiv.style.display =
      intervsDiv.style.display  = 'none';
      btnMap.classList.remove('active');
      btnCasernes.classList.remove('active');
      btnInterventions.classList.remove('active');
      if (tab==='map') {
        mapDiv.style.display = 'block';
        btnMap.classList.add('active');
        setTimeout(()=> map.invalidateSize(), 200);
      }
      if (tab==='casernes') {
        casernesDiv.style.display = 'block';
        btnCasernes.classList.add('active');
      }
      if (tab==='interventions') {
        intervsDiv.style.display = 'block';
        btnInterventions.classList.add('active');
      }
    }

    // 8) Cross-navigation
    function openCaserne(name) {
      showTab('casernes');
      const item = casernesDiv.querySelector(`.station-item[data-name="${name}"]`);
      if (item) { item.scrollIntoView({behavior:'smooth',block:'center'}); item.click(); }
    }
    function openIntervention(id) {
      showTab('interventions');
      const item = intervsDiv.querySelector(`.intervention-item[data-id="${id}"]`);
      if (item) { item.scrollIntoView({behavior:'smooth',block:'center'}); item.click(); }
    }
    function openIntervOnMap(id) {
      showTab('map');
      const mrk = interventionMarkersIsere[id] || interventionMarkersRhône[id];
      if (mrk) {
        map.setView(mrk.getLatLng(), map.getZoom());
        mrk.openPopup();
      }
    }

// 9) Init map & markers (ajout d'un fallback Nominatim pour géocoder si GPS invalide)
let map;
function initMap() {
  map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap contributors'
  }).addTo(map);

  // casernes
  stations.forEach(s=>{
    const link = `<a href="#" class="popup-caserne" data-name="${s.nom}">CT ${s.nom}</a>`;
    const m = L.marker([s.lat,s.lng], {icon:iconRed})
                .addTo(map)
                .bindPopup(link);
    stationMarkers[s.nom] = m;
  });

  // normalizeCentreName (utilisé pour engagedMap / affichage)
  function normalizeCentreName(raw) {
    if (!raw) return raw;
    const r = String(raw).trim();
    const norm = r.replace(/\s+/g,' ').toUpperCase();
    if (/(COLOMBE.*SAINTE|SAINTE.*COLOMBE|COLOMBE,\s*SAINTE)/.test(norm)) return 'Sainte-Colombe';
    return raw;
  }

  // builder popup html réutilisable
  function buildPopupHtmlFromGrouped(id, title, addr, grouped) {
    let html = `<a href="#" class="popup-interv" data-id="${id}"><strong>${title}</strong></a>`;
    if (addr) html += `<p>${addr}</p>`;
    html += `<div style="margin-top:8px;">`;
    Object.entries(grouped).forEach(([centre, vehs])=>{
      html += `<div class="interv-detail"><div style="font-weight:bold;">${centre} :</div><div class="vehicles-row">`;
      html += vehs.map(v => `<div class="vehicle ${getStatusClass(v.status)}">${v.code}</div>`).join('');
      html += `</div></div>`;
    });
    html += `</div>`;
    return html;
  }

  // helper: Nominatim geocode (returns Promise<{lat,lon}> or null)
  function geocodeNominatim(address) {
    if (!address || !address.trim()) return Promise.resolve(null);
    const q = encodeURIComponent(address);
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=fr&q=${q}`;
    return fetch(url, { headers: { 'Accept-Language': 'fr' } })
      .then(r => r.ok ? r.json() : Promise.resolve([]))
      .then(res => {
        if (!res || !res.length) return null;
        const lat = parseFloat(res[0].lat), lon = parseFloat(res[0].lon);
        if (isNaN(lat) || isNaN(lon)) return null;
        return { lat, lon };
      })
      .catch(() => null);
  }

  // ------- Rhône interventions : child_added / child_changed / child_removed -------
  const refRh = db.ref('Interventions');
  refRh.off();
  refRh.on('child_added', snap => upsertRhôneIntervention(snap.key, snap.val()));
  refRh.on('child_changed', snap => upsertRhôneIntervention(snap.key, snap.val()));
  refRh.on('child_removed', snap => removeRhôneIntervention(snap.key));

  function upsertRhôneIntervention(id, itv) {
    try {
      // parse GPS robustement (accepte tableau ou objet ou champs au parent)
      let lat = NaN, lng = NaN;
      const g = itv.gps;
      if (Array.isArray(g) && g.length >= 2) { lat = parseFloat(g[0]); lng = parseFloat(g[1]); }
      else if (g && typeof g === 'object') { lat = parseFloat(g.lat ?? g.latitude ?? g[0]); lng = parseFloat(g.lng ?? g.longitude ?? g[1]); }
      else { lat = parseFloat(itv.lat ?? itv.latitude); lng = parseFloat(itv.lng ?? itv.longitude); }

      // normaliser les nombres
      if (!Number.isFinite(lat)) lat = NaN;
      if (!Number.isFinite(lng)) lng = NaN;

      // construire grouped centre -> [{code,status}] et remplir engagedMap (normalisation utilisée pour clefs)
      const vehsRoot = itv.vehicules || {};
      const grouped = {};
      Object.keys(vehsRoot).sort((a,b)=>parseInt(a,10)-parseInt(b,10)).forEach(k=>{
        const obj = vehsRoot[k];
        if (!obj || typeof obj === 'string') return;
        Object.entries(obj).forEach(([centreName, engObj])=>{
          const displayCentre = normalizeCentreName(centreName);
          if (!grouped[displayCentre]) grouped[displayCentre] = [];
          if (typeof engObj === 'object') {
            Object.entries(engObj).forEach(([enginName, engData])=>{
              const status = engData && (engData.Statut ?? engData.statut ?? engData.status) ? (engData.Statut ?? engData.statut ?? engData.status) : (obj.Statut || '');
              grouped[displayCentre].push({ code: enginName, status: String(status||'').trim() });
              engagedMap[`${displayCentre}_${enginName}`] = id;
            });
          }
        });
      });

      // helper pour créer / mettre à jour marker une fois coordonnées dispo
      function placeOrUpdateRhôneMarker(latp, lngp) {
        if (Number.isNaN(latp) || Number.isNaN(lngp)) return;
        if (interventionMarkersRhône[id]) {
          const mrk = interventionMarkersRhône[id];
          interventionDataRhône[id] = { itv, grouped };
          // on met à jour popup si ouvert
          if (mrk.getPopup() && mrk.isPopupOpen()) {
            const title = itv.createdAt || itv.dhDebutInter || '';
            const addr = itv.adresse || itv.Adresse || '';
            mrk.getPopup().setContent(buildPopupHtmlFromGrouped(id, `${title} - ${itv.motif || itv.sinistreCourant || ''}`, addr, grouped));
          }
        } else {
          // créer le marker
          const mrk = L.marker([latp, lngp], {icon:makeItvIconRhône()}).addTo(map);
          interventionMarkersRhône[id] = mrk;
          interventionDataRhône[id] = { itv, grouped };
          mrk.bindPopup('Chargement…');
          mrk.on('popupopen', ()=> {
            const title = itv.createdAt || itv.dhDebutInter || '';
            const addr = itv.adresse || itv.Adresse || '';
            mrk.getPopup().setContent(buildPopupHtmlFromGrouped(id, `${title} - ${itv.motif || itv.sinistreCourant || ''}`, addr, grouped));
            refreshInterventionsListOpenItems();
          });
          mrk.on('click', ()=> mrk.openPopup());
        }
      }

      // si GPS valide on place directement, sinon on tente Nominatim sur l'adresse disponible
      if (!isNaN(lat) && !isNaN(lng)) {
        placeOrUpdateRhôneMarker(lat, lng);
      } else {
        // construire chaîne adresse prioritaire : adresse / Adresse / motif + commune fields
        const candidates = [];
        if (itv.adresse) candidates.push(itv.adresse);
        if (itv.Adresse) candidates.push(itv.Adresse);
        // concat possibles (commune fields communes or zone)
        if (itv.commune) candidates.push(`${itv.commune}`);
        if (itv.Commune) candidates.push(`${itv.Commune}`);
        if (itv.ville) candidates.push(`${itv.ville}`);
        // ajoute motif pour aider si rien d'autre
        if (itv.motif) candidates.push(itv.motif);
        // join and cleanup parentheses and double spaces
        const rawAddr = candidates.filter(Boolean).join(' ');
        const cleaned = rawAddr.replace(/\([^)]*\)/g,'').replace(/\s+/g,' ').trim();
        // fallback: if cleaned empty, use id as label (no geocode)
        if (!cleaned) {
          console.warn(`Intervention ${id} : pas d'adresse pour géocoding Nominatim`, itv);
          return;
        }
        geocodeNominatim(cleaned).then(coord => {
          if (coord) placeOrUpdateRhôneMarker(coord.lat, coord.lon);
          else console.warn(`Intervention ${id} : Nominatim n'a rien trouvé pour "${cleaned}"`);
        });
      }
    } catch(e) {
      console.error('Erreur upsert Rhône', id, e);
    }
  }

  function removeRhôneIntervention(id) {
    try {
      const mrk = interventionMarkersRhône[id];
      if (mrk) { map.removeLayer(mrk); delete interventionMarkersRhône[id]; }
      delete interventionDataRhône[id];
      Object.keys(engagedMap).forEach(k=>{ if (engagedMap[k] === id) delete engagedMap[k]; });
      refreshInterventionsListOpenItems();
    } catch(e){ console.warn('removeRhôneIntervention', e); }
  }

  // ------- Isère interventions : child_added / child_changed / child_removed (inchangés) -------
  const refIsere = db.ref('Isère/Interventions');
  refIsere.off();
  refIsere.on('child_added', snap => upsertIsereIntervention(snap.key, snap.val()));
  refIsere.on('child_changed', snap => upsertIsereIntervention(snap.key, snap.val()));
  refIsere.on('child_removed', snap => removeIsereIntervention(snap.key));

  function upsertIsereIntervention(id, itv) {
    if (!itv) return;
    const addr = itv['Adresse'] || '';
    const dh = itv['dhDebutInter'] || '';
    const motif = itv['sinistreCourant'] || '';
    db.ref(`Isère/Interventions/${id}/Engins Engagés`).on('value', esnap => {
      try {
        const engOrdered = esnap.val() || {};
        const groups = {};
        Object.keys(engOrdered).sort((a,b)=>parseInt(a,10)-parseInt(b,10)).forEach(orderKey => {
          const centresObj = engOrdered[orderKey] || {};
          Object.entries(centresObj).forEach(([centreName, enginsObj]) => {
            const displayCentre = normalizeCentreName(centreName);
            if (!groups[displayCentre]) groups[displayCentre] = [];
            Object.entries(enginsObj || {}).forEach(([enginName, engData]) => {
              let statut = engData && (engData.Statut ?? engData.statut ?? engData.status) ? (engData.Statut ?? engData.statut ?? engData.status) : '';
              if (displayCentre === 'Sainte-Colombe' && stationData['Sainte-Colombe'] && stationData['Sainte-Colombe'][enginName]) {
                const sd = stationData['Sainte-Colombe'][enginName];
                if (sd && typeof sd === 'object') statut = sd.Statut ?? sd.statut ?? sd.status ?? statut;
                else if (typeof sd === 'string') statut = sd || statut;
              }
              groups[displayCentre].push({ code: enginName, status: String(statut||'').trim() });
              engagedMap[`${displayCentre}_${enginName}`] = id;
            });
          });
        });

        interventionDataIsere[id] = { itv, groups, addr, dh, motif };

        if (interventionMarkersIsere[id]) {
          const mrk = interventionMarkersIsere[id];
          if (mrk.getPopup() && mrk.isPopupOpen()) {
            mrk.getPopup().setContent(buildPopupHtmlFromGrouped(id, `${dh} - ${motif}`, addr, groups));
            refreshInterventionsListOpenItems();
          }
        } else {
          if (!addr) return;
          fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`)
            .then(r => r.json())
            .then(res => {
              if (!res.length) return;
              const lat = parseFloat(res[0].lat), lon = parseFloat(res[0].lon);
              if (isNaN(lat) || isNaN(lon)) return;
              const mrk = L.marker([lat, lon], { icon: makeItvIconIsere(id) }).addTo(map);
              interventionMarkersIsere[id] = mrk;
              mrk.bindPopup('Chargement…');
              mrk.on('popupopen', ()=> {
                mrk.getPopup().setContent(buildPopupHtmlFromGrouped(id, `${dh} - ${motif}`, addr, groups));
                refreshInterventionsListOpenItems();
              });
              mrk.on('click', ()=> mrk.openPopup());
            }).catch(console.warn);
        }
      } catch(e) { console.warn('upsertIsereEngines', id, e); }
    });
  }

  function removeIsereIntervention(id) {
    try {
      const mrk = interventionMarkersIsere[id];
      if (mrk) { map.removeLayer(mrk); delete interventionMarkersIsere[id]; }
      if (interventionDataIsere[id] && interventionDataIsere[id].engRef) {
        db.ref(`Isère/Interventions/${id}/Engins Engagés`).off();
      }
      delete interventionDataIsere[id];
      Object.keys(engagedMap).forEach(k=>{ if (engagedMap[k] === id) delete engagedMap[k]; });
      refreshInterventionsListOpenItems();
    } catch(e){ console.warn('removeIsereIntervention', e); }
  }

  // cross-links dans tous les popups
  map.on('popupopen', e=>{
    const el = e.popup.getElement();
    const linkC = el.querySelector('.popup-caserne');
    if (linkC) linkC.onclick = ev=>{
      ev.preventDefault();
      openCaserne(linkC.dataset.name);
    };
    const linkI = el.querySelector('.popup-interv');
    if (linkI) linkI.onclick = ev=>{
      ev.preventDefault();
      openIntervention(linkI.dataset.id);
    };
  });

  // ajuster la vue sur les casernes
  map.fitBounds(
    L.latLngBounds(stations.map(s=>[s.lat,s.lng])),
    { padding:[50,50] }
  );
}

    // 10) Casernes list
const synMap = {}; // stocke le DOM synoptique par nom de caserne pour rafraîchissement temps réel

function initCasernesList() {
  casernesDiv.innerHTML = '';

  stations.slice().sort((a,b)=>a.nom.localeCompare(b.nom))
    .forEach(s=>{
      const item = document.createElement('div');
      item.className    = 'station-item';
      item.textContent  = s.nom;
      item.dataset.name = s.nom;
      casernesDiv.appendChild(item);

      const syn = document.createElement('div');
      syn.className = 'synoptic hidden';
      casernesDiv.appendChild(syn);

      // garder la référence pour updates en temps réel
      synMap[s.nom] = syn;

      item.onclick = ()=> {
        togglePopulateSynoptic(s.nom, syn);
      };
    });
}

function togglePopulateSynoptic(name, syn) {
  if (syn.classList.contains('hidden')) {
    populateCaserneSynoptic(name, syn);
    syn.classList.remove('hidden');
  } else {
    syn.classList.add('hidden');
  }
}

function populateCaserneSynoptic(name, syn) {
  syn.innerHTML = '';
  let cats, dataObj;

  if (name === 'Condrieu') {
    cats    = categories;
    dataObj = stationData['Condrieu'] || {};
  } else if (name === 'Vienne') {
    cats    = categoriesVienne;
    dataObj = centreData['Vienne'] || {};
  } else if (name === 'Chasse-sur-Rhône') {
    cats    = categoriesChasse;
    dataObj = centreData['Chasse-sur-Rhône'] || {};
  } else if (name === 'Sainte-Colombe') {
    const catsSte = {
      "Secours à Personne":["VSAV 01"],
      "Incendie":["FPTL 01","CCFM 01"],
      "Opérations Diverses":["VFI 01","VTUTP 01"],
      "Commandement":["VLCDG 01"],
      "Secours Nautiques":["BMS 01","R2BLS 01"],
      "Remorque Cellule Lot":[
        "LBACHE 01","LBALIS 01","LCTHER 01",
        "LDNOY 01","LECLE 01","LTRON 01"
      ]
    };
    dataObj = stationData['Sainte-Colombe'] || {};

    Object.entries(catsSte).forEach(([cat,list])=>{
      const sec   = document.createElement('div');
      sec.className = 'category-section';
      const title = document.createElement('div');
      title.className = 'category-title';
      title.textContent = cat;
      sec.appendChild(title);
      const row   = document.createElement('div');
      row.className = 'vehicles-row';

      list.forEach(keyName=>{
        let st = '';
        if (dataObj && dataObj[keyName] !== undefined) {
          const val = dataObj[keyName];
          if (val && typeof val === 'object') st = val.Statut ?? val.statut ?? val.status ?? '';
          else if (typeof val === 'string') st = val;
        }
        const v = document.createElement('div');
        v.className = `vehicle ${getStatusClass(st)}`;
        v.textContent = keyName;
        row.appendChild(v);
      });

      sec.appendChild(row);
      syn.appendChild(sec);
    });

    return;
  } else {
    cats    = { "Secours à Personne":["VSAV 01"] };
    dataObj = stationData[name] || {};
  }

  Object.entries(cats).forEach(([cat, list])=>{
    const sec   = document.createElement('div');
    sec.className = 'category-section';
    const title = document.createElement('div');
    title.className = 'category-title';
    title.textContent = cat;
    sec.appendChild(title);
    const row   = document.createElement('div');
    row.className = 'vehicles-row';
    list.forEach(keyName=>{
      let st = '';
      if (dataObj && dataObj[keyName] !== undefined) {
        const val = dataObj[keyName];
        if (val && typeof val === 'object') st = val.Statut ?? val.statut ?? val.status ?? '';
        else if (typeof val === 'string') st = val;
      }
      const v = document.createElement('div');
      v.className = `vehicle ${getStatusClass(st)}`;
      v.textContent = keyName;
      row.appendChild(v);
    });
    sec.appendChild(row);
    syn.appendChild(sec);
  });
}

function refreshCaserneSynoptic(name) {
  const syn = synMap[name];
  if (!syn) return;
  if (!syn.classList.contains('hidden')) {
    populateCaserneSynoptic(name, syn);
  }
}

   // 11) subscribeInterventionsList — rebuild + debug + live
function subscribeInterventionsList() {
  intervsDiv.innerHTML = '';

  // detach previous handlers
  db.ref('Interventions').off();
  db.ref('Isère/Interventions').off();

  // reset caches to avoid "stuck" ids
  const seenRhone = new Set();
  const seenIsere = new Set();
  Object.keys(engagedMap).forEach(k => delete engagedMap[k]);

  function normalizeCentreName(raw) {
    if (!raw) return raw;
    const r = String(raw).trim();
    const norm = r.replace(/\s+/g,' ').toUpperCase();
    if (/(COLOMBE.*SAINTE|SAINTE.*COLOMBE|COLOMBE,\s*SAINTE)/.test(norm)) return 'Sainte-Colombe';
    return raw;
  }

  function buildGroupFromRhône(itv) {
    const grouped = {};
    const vehs = itv.vehicules || {};
    Object.keys(vehs).sort((a,b)=>parseInt(a,10)-parseInt(b,10)).forEach(k=>{
      const obj = vehs[k];
      if (!obj || typeof obj === 'string') return;
      Object.entries(obj).forEach(([centreName, engObj])=>{
        const displayCentre = normalizeCentreName(centreName);
        if (!grouped[displayCentre]) grouped[displayCentre] = [];
        if (typeof engObj === 'object') {
          Object.entries(engObj).forEach(([enginName, engData])=>{
            const status = engData && (engData.Statut ?? engData.statut ?? engData.status) ? (engData.Statut ?? engData.statut ?? engData.status) : '';
            grouped[displayCentre].push({ code: enginName, status: String(status||'').trim() });
            engagedMap[`${displayCentre}_${enginName}`] = itv.id || itv._id || null;
          });
        }
      });
    });
    return grouped;
  }

  function upsertListItem(id, source, time, motif, address, grouped) {
    let item = intervsDiv.querySelector(`.intervention-item[data-id="${id}"][data-source="${source}"]`);
    let syn;
    if (!item) {
      item = document.createElement('div');
      item.className = 'intervention-item';
      item.dataset.id = id;
      item.dataset.source = source;
      item.innerHTML = `<strong>${time} - ${motif}</strong>`;
      syn = document.createElement('div');
      syn.className = 'interv-synoptic hidden';
      intervsDiv.append(item, syn);

// création initiale (item.addEventListener)
item.addEventListener('click', () => {
  if (!syn._init) {
    syn.innerHTML = '';

    // Adresse (titre + valeur)
    if (address) {
      const titleAddr = document.createElement('div');
      titleAddr.style.fontWeight = 'bold';
      titleAddr.style.marginBottom = '6px';
      titleAddr.textContent = 'Adresse';
      syn.appendChild(titleAddr);

      const pAddr = document.createElement('p');
      pAddr.textContent = address;
      syn.appendChild(pAddr);

      // trait de séparation léger
      const hr = document.createElement('div');
      hr.style.borderTop = '1px solid #e0e0e0';
      hr.style.margin = '8px 0';
      syn.appendChild(hr);
    }

    // En-têtes Centre / Engins engagés (même couleur pour les deux)
    const headerRow = document.createElement('div');
    headerRow.style.display = 'flex';
    headerRow.style.alignItems = 'center';
    headerRow.style.padding = '4px 10px';
    headerRow.style.fontWeight = 'bold';

    const hCentre = document.createElement('div');
    hCentre.textContent = 'Centre';
    hCentre.style.flex = '0 0 35%';
    hCentre.style.maxWidth = '35%';
    hCentre.style.color = '#000'; // même couleur que Engins engagés
    headerRow.appendChild(hCentre);

    const hEngins = document.createElement('div');
    hEngins.textContent = 'Engins engagés';
    hEngins.style.flex = '1 1 65%';
    hEngins.style.textAlign = 'left';
    hEngins.style.color = '#000';
    hEngins.style.marginLeft = '4%'; // léger décalage visuel
    headerRow.appendChild(hEngins);

    syn.appendChild(headerRow);

    // contenu centres + engins, alignement propre
    Object.entries(grouped).forEach(([centre, engs])=>{
      const detail = document.createElement('div');
      detail.className = 'interv-detail';
      detail.style.display = 'flex';
      detail.style.alignItems = 'flex-start';
      detail.style.padding = '6px 0';
      detail.style.columnGap = '12px';

      const left = document.createElement('div');
      left.textContent = centre;
      left.style.fontWeight = 'bold';
      left.style.flex = '0 0 35%';
      left.style.maxWidth = '35%';
      left.style.color = '#000';          // même couleur que l'en-tête
      left.style.wordBreak = 'break-word';

      const right = document.createElement('div');
      right.className = 'vehicles-row';
      right.style.flex = '1 1 65%';
      right.style.display = 'flex';
      right.style.flexWrap = 'wrap';
      right.style.gap = '6px';
      right.style.alignItems = 'flex-start';

      engs.forEach(e=>{
        const vb = document.createElement('div');
        vb.className = `vehicle ${getStatusClass(e.status)}`;
        vb.textContent = e.code;
        right.appendChild(vb);
      });

      detail.appendChild(left);
      detail.appendChild(right);
      syn.appendChild(detail);
    });

    syn._init = true;
    syn.classList.remove('hidden');
  } else {
    syn.classList.toggle('hidden');
  }
});

// mise à jour d'un item existant (else branch)
} else {
  syn = item.nextElementSibling;

  // Toujours (re)construire le synoptique si on a des données à jour.
  if (syn) {
    syn.innerHTML = '';

    if (address) {
      const titleAddr = document.createElement('div');
      titleAddr.style.fontWeight = 'bold';
      titleAddr.style.marginBottom = '6px';
      titleAddr.textContent = 'Adresse';
      syn.appendChild(titleAddr);

      const pAddr = document.createElement('p');
      pAddr.textContent = address;
      syn.appendChild(pAddr);

      const hr = document.createElement('div');
      hr.style.borderTop = '1px solid #e0e0e0';
      hr.style.margin = '8px 0';
      syn.appendChild(hr);
    }

    const headerRow = document.createElement('div');
    headerRow.style.display = 'flex';
    headerRow.style.alignItems = 'center';
    headerRow.style.padding = '4px 10px';
    headerRow.style.fontWeight = 'bold';

    const hCentre = document.createElement('div');
    hCentre.textContent = 'Centre';
    hCentre.style.flex = '0 0 35%';
    hCentre.style.maxWidth = '35%';
    hCentre.style.color = '#000';
    headerRow.appendChild(hCentre);

    const hEngins = document.createElement('div');
    hEngins.textContent = 'Engins engagés';
    hEngins.style.flex = '1 1 65%';
    hEngins.style.textAlign = 'left';
    hEngins.style.color = '#000';
    hEngins.style.marginLeft = '4%';
    headerRow.appendChild(hEngins);

    syn.appendChild(headerRow);

    Object.entries(grouped).forEach(([centre, engs])=>{
      const detail = document.createElement('div');
      detail.className = 'interv-detail';
      detail.style.display = 'flex';
      detail.style.alignItems = 'flex-start';
      detail.style.padding = '6px 0';
      detail.style.columnGap = '12px';

      const left = document.createElement('div');
      left.textContent = centre;
      left.style.fontWeight = 'bold';
      left.style.flex = '0 0 35%';
      left.style.maxWidth = '35%';
      left.style.color = '#000';
      left.style.wordBreak = 'break-word';

      const right = document.createElement('div');
      right.className = 'vehicles-row';
      right.style.flex = '1 1 65%';
      right.style.display = 'flex';
      right.style.flexWrap = 'wrap';
      right.style.gap = '6px';
      right.style.alignItems = 'flex-start';

      engs.forEach(e=>{
        const vb = document.createElement('div');
        vb.className = `vehicle ${getStatusClass(e.status)}`;
        vb.textContent = e.code;
        right.appendChild(vb);
      });

      detail.appendChild(left);
      detail.appendChild(right);
      syn.appendChild(detail);
    });

    syn._init = true;
    }
  }
}

  // --- initial sync: rebuild list from current DB snapshots to ensure nothing missed ---
  Promise.all([
    db.ref('Interventions').once('value'),
    db.ref('Isère/Interventions').once('value')
  ]).then(([snapR, snapI]) => {
    const rVal = snapR.val() || {};
    const iVal = snapI.val() || {};

    // Rhône initials
    Object.entries(rVal).forEach(([id, itv])=>{
      const it = itv || {};
      it.id = id;
      const grouped = buildGroupFromRhône(it);
      const time = it.createdAt || it.dhDebutInter || '';
      const motif = it.motif || it.sinistreCourant || '';
      const address = it.adresse || it.Adresse || '';
      // add regardless now; Isère listener will later update/duplicate if also present
      upsertListItem(id, 'rhone', time, motif, address, grouped);
      seenRhone.add(id);
    });

    // Isère initials
    Object.entries(iVal).forEach(([id, itv])=>{
      const it = itv || {};
      const time = it.dhDebutInter || it.createdAt || '';
      const motif = it.sinistreCourant || '';
      const address = it.Adresse || '';
      // get Engins Engagés snapshot synchronously if present
      db.ref(`Isère/Interventions/${id}/Engins Engagés`).once('value').then(esnap=>{
        const engOrdered = esnap.val() || {};
        const groups = {};
        Object.keys(engOrdered).sort((a,b)=>parseInt(a,10)-parseInt(b,10)).forEach(orderKey=>{
          const centresObj = engOrdered[orderKey] || {};
          Object.entries(centresObj).forEach(([centreName, enginsObj])=>{
            const displayCentre = normalizeCentreName(centreName);
            if (!groups[displayCentre]) groups[displayCentre] = [];
            Object.entries(enginsObj || {}).forEach(([enginName, engData])=>{
              const statut = engData && (engData.Statut ?? engData.statut ?? engData.status) ? (engData.Statut ?? engData.statut ?? engData.status) : '';
              groups[displayCentre].push({ code: enginName, status: String(statut||'').trim() });
              engagedMap[`${displayCentre}_${enginName}`] = id;
            });
          });
        });
        upsertListItem(id, 'isere', time, motif, address, groups);
        seenIsere.add(id);
      }).catch(e=>{ console.warn('isere eng fetch failed', id, e); upsertListItem(id, 'isere', time, motif, address, {}); seenIsere.add(id); });
    });

    console.log('[DEBUG] initial sync done. Rhône:', Array.from(seenRhone).length, 'Isere:', Array.from(seenIsere).length);
  }).catch(e => console.error('initial sync failed', e));

  // --- live listeners (kept after initial sync) ---
  db.ref('Interventions').on('child_added', snap => {
    const id = snap.key;
    const itv = snap.val() || {};
    itv.id = id;
    if (seenRhone.has(id)) return; // avoid duplicate adds from initial sync
    const grouped = buildGroupFromRhône(itv);
    const time = itv.createdAt || itv.dhDebutInter || '';
    const motif = itv.motif || itv.sinistreCourant || '';
    const address = itv.adresse || itv.Adresse || '';
    upsertListItem(id, 'rhone', time, motif, address, grouped);
    seenRhone.add(id);
    console.log('[DEBUG] live Rhône added', id);
  });

  db.ref('Interventions').on('child_changed', snap=>{
    const id = snap.key; const itv = snap.val()||{}; itv.id = id;
    const grouped = buildGroupFromRhône(itv);
    const time = itv.createdAt || itv.dhDebutInter || '';
    const motif = itv.motif || itv.sinistreCourant || '';
    const address = itv.adresse || itv.Adresse || '';
    upsertListItem(id, 'rhone', time, motif, address, grouped);
    console.log('[DEBUG] live Rhône changed', id);
  });

  db.ref('Interventions').on('child_removed', snap=>{
    const id = snap.key;
    const el = intervsDiv.querySelector(`.intervention-item[data-id="${id}"][data-source="rhone"]`);
    if (el) { const syn = el.nextElementSibling; el.remove(); if (syn) syn.remove(); }
    seenRhone.delete(id);
    Object.keys(engagedMap).forEach(k=>{ if (engagedMap[k] === id) delete engagedMap[k]; });
    console.log('[DEBUG] live Rhône removed', id);
  });

  // Isère live: add + keep Engins Engagés value listener
  db.ref('Isère/Interventions').on('child_added', snap => {
    const id = snap.key;
    const itv = snap.val() || {};
    console.log('[DEBUG] Isere child_added', id, itv);
    if (seenIsere.has(id)) return;
    seenIsere.add(id);
    const time = itv.dhDebutInter || itv.createdAt || '';
    const motif = itv.sinistreCourant || '';
    const address = itv.Adresse || '';

    // initial empty group, will be filled by engRef listener below
    upsertListItem(id, 'isere', time, motif, address, {});

    const engRef = db.ref(`Isère/Interventions/${id}/Engins Engagés`);
    engRef.off(); // ensure single listener
    engRef.on('value', esnap => {
      console.log('[DEBUG] Isere Engins Engagés update', id, esnap.val());
      const engOrdered = esnap.val() || {};
      const groups = {};
      Object.keys(engOrdered).sort((a,b)=>parseInt(a,10)-parseInt(b,10)).forEach(orderKey=>{
        const centresObj = engOrdered[orderKey] || {};
        Object.entries(centresObj).forEach(([centreName, enginsObj])=>{
          const displayCentre = normalizeCentreName(centreName);
          if (!groups[displayCentre]) groups[displayCentre] = [];
          Object.entries(enginsObj || {}).forEach(([enginName, engData])=>{
            let statut = engData && (engData.Statut ?? engData.statut ?? engData.status) ? (engData.Statut ?? engData.statut ?? engData.status) : '';
            if (displayCentre === 'Sainte-Colombe' && stationData['Sainte-Colombe'] && stationData['Sainte-Colombe'][enginName]) {
              const sd = stationData['Sainte-Colombe'][enginName];
              if (sd && typeof sd === 'object') statut = sd.Statut ?? sd.statut ?? sd.status ?? statut;
              else if (typeof sd === 'string') statut = sd || statut;
            }
            groups[displayCentre].push({ code: enginName, status: String(statut||'').trim() });
            engagedMap[`${displayCentre}_${enginName}`] = id;
          });
        });
      });

      // update list entry for this Isère intervention
      upsertListItem(id, 'isere', time, motif, address, groups);

      // update popup if marker exists
      if (interventionMarkersIsere[id]) {
        const mrk = interventionMarkersIsere[id];
        if (mrk.getPopup()) mrk.getPopup().setContent(
          (function build(){ 
            let html = `<a href="#" class="popup-interv" data-id="${id}"><strong>${time} - ${motif}</strong></a>`;
            if (address) html += `<p>${address}</p>`;
            html += `<div style="margin-top:8px;">`;
            Object.entries(groups).forEach(([centre, vehs])=>{
              html += `<div class="interv-detail"><div style="font-weight:bold;">${centre} :</div><div class="vehicles-row">`;
              html += vehs.map(v => `<div class="vehicle ${getStatusClass(v.status)}">${v.code}</div>`).join('');
              html += `</div></div>`;
            });
            html += `</div>`;
            return html;
          })()
        );
      }
    });
  });

  db.ref('Isère/Interventions').on('child_changed', snap=>{
    const id = snap.key; const itv = snap.val()||{};
    console.log('[DEBUG] Isere child_changed', id, itv);
    const item = intervsDiv.querySelector(`.intervention-item[data-id="${id}"][data-source="isere"]`);
    if (item) item.innerHTML = `<strong>${itv.dhDebutInter || itv.createdAt || ''} - ${itv.sinistreCourant || ''}</strong>`;
  });

  db.ref('Isère/Interventions').on('child_removed', snap=>{
    const id = snap.key;
    const el = intervsDiv.querySelector(`.intervention-item[data-id="${id}"][data-source="isere"]`);
    if (el) { const syn = el.nextElementSibling; el.remove(); if (syn) syn.remove(); }
    seenIsere.delete(id);
    Object.keys(engagedMap).forEach(k=>{ if (engagedMap[k] === id) delete engagedMap[k]; });
    console.log('[DEBUG] Isere child_removed', id);
  });

  console.log('[DEBUG] subscribeInterventionsList attached');
}

    // 12) Badge → carte
   casernesDiv.addEventListener('click', e => {
  const el = e.target.closest('.vehicle');
  if (!el) return;
  e.stopPropagation();
  const text = el.textContent.trim();
  const parts = text.split(' : ');
  const stationName = parts.length === 2 ? parts[0] : text.split(' ')[0];
  const code        = parts.length === 2 ? parts[1] : text.split(' ').slice(1).join(' ');
  const id = engagedMap[`${stationName}_${code}`];
  if (id) openIntervOnMap(id);
});


    // 13) Bottombar
    btnMap.addEventListener('click',        () => showTab('map'));
    btnInterventions.addEventListener('click', () => showTab('interventions'));
    btnCasernes.addEventListener('click',   () => showTab('casernes'));

    // 14) Au chargement
    window.addEventListener('DOMContentLoaded', () => {
      initMap();
      initCasernesList();
      subscribeInterventionsList();
      showTab('map');
    });
  </script>
</body>
</html>
```
