<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIS SDMIS</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f8f8f8;
    }

    header {
      background-color: #b30000;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 1.5em;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    select {
      margin-top: 10px;
      padding: 8px;
      font-size: 1em;
      width: 90%;
      max-width: 300px;
    }

    .category-section {
      margin: 20px 0;
    }

    .category-title {
      margin: 0 15px 8px;
      font-weight: bold;
      font-size: 1.2em;
      color: #b30000;
    }

    .vehicles-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0 15px;
    }

    .vehicle {
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1em;
      flex: 0 0 auto;
    }

    /* Statuts et couleurs associées */
    .DM { background-color: #d3d3d3; color: #000000; } /* gris fallback */
    .IN { background-color: #ffffff; color: #000000; }
    .DL { background-color: #90ee90; color: #000000; }  /* vert clair/texte noir */
    .RE { background-color: #006400; color: #000000; }  /* vert foncé/texte noir */
    .AL { background-color: #ffeb3b; color: #d32f2f; }  /* jaune-orangé/texte rouge */
    .PA { background-color: #d32f2f; color: #ffffff; }  /* rouge/texte blanc */
    .SL { background-color: #d32f2f; color: #000000; }  /* rouge/texte noir */
    .TH { background-color: #ffffff; color: #5c6bc0; }  /* blanc/texte bleu-violet */
    .AH { background-color: #ffffff; color: #000000; }  /* blanc/texte noir */
    .PC { background-color: #ffffff; color: #388e3c; }  /* blanc/texte vert clair */
    .QH { background-color: #ffffff; color: #ff9800; }  /* blanc/texte orange */
    .RD { background-color: #5c6bc0; color: #000000; }  /* bleu-violet/texte noir */
    .RI { background-color: #5c6bc0; color: #ffffff; }  /* bleu-violet/texte blanc */
    .MD { background-color: #9c27b0; color: #000000; }  /* violet/texte noir */
    .MI { background-color: #9c27b0; color: #ffffff; }  /* violet/texte blanc */
    .default { background-color: #d3d3d3; color: #000000; } /* gris fallback */
  </style>
</head>
<body>
  <header>
    CIS SDMIS<br>
    <select id="caserneSelect">
      <option value="Ampuis">Ampuis</option>
      <option value="Condrieu">Condrieu</option>
      <option value="Sainte-Colombe">Sainte-Colombe</option>
    </select>
  </header>

  <div id="vehicleContainer"></div>

  <script>
    // -- Initialisation Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCe6_BM4BtT0fi6-yudBOAMIkPueq2rKYA",
      authDomain: "cis-sdmis.firebaseapp.com",
      databaseURL: "https://cis-sdmis-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cis-sdmis",
      storageBucket: "cis-sdmis.firebasestorage.app",
      messagingSenderId: "305775040783",
      appId: "1:305775040783:web:28abe37dc830d2e3ab067a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // -- Références & état
    const caserneSelect = document.getElementById("caserneSelect");
    const container     = document.getElementById("vehicleContainer");
    let currentRef      = null;

    // -- Catégories & ordre d'affichage
    const categories = {
      "Secours à Personne": ["VLINF 01","VSAV 01","VSAV 02"],
      "Incendie":           ["CCFM 01","CCI 01","FPTASR 01","FPTL 01"],
      "Echelle":            ["EPS24 01"],
      "Operations Diverses":["VFI 01","VFIHR 01","VTUTP 01"],
      "Commandement":       ["VLCDG 01"],
      "Remorque Cellule Lot":[
        "BMS 01","LBACHE 01","LBALIS 01","LCITS5 01",
        "LDEPOL 01","LDNROY 01","LECLE 01","LELEC 01",
        "LGAZ 01","LTRON 01","MPR 01","R2BLS 01"
      ]
    };

    // Retourne la classe CSS d'après le code statut
    function getStatusClass(raw) {
      const status = String(raw || "").trim().toUpperCase();
      switch (status) {
        case "DL": return "DL";
        case "RE": return "RE";
        case "AL": return "AL";
        case "PA": return "PA";
        case "SL": return "SL";
        case "TH": return "TH";
        case "AH": return "AH";
        case "PC": return "PC";
        case "QH": return "QH";
        case "RD": return "RD";
        case "RI": return "RI";
        case "MD": return "MD";
        case "MI": return "MI";
        case "IN": return "IN";
        case "DM": return "DM";
        default:   return "default";
      }
    }

    // Charge et écoute en temps réel les Engins d’une caserne
    function loadVehicles(caserne) {
      if (currentRef) currentRef.off();  // stop écoute précédente
      container.innerHTML = "";

      currentRef = db.ref(`CIS/${caserne}/Engins`);
      currentRef.on("value", snap => {
        container.innerHTML = "";
        const data = snap.val() || {};

        // si pas de données, fallback
        if (!Object.keys(data).length) {
          container.innerHTML = `
            <div class="category-section">
              <div class="category-title">Véhicules</div>
              <div class="vehicles-row">
                <div class="vehicle default">VSAV 01</div>
              </div>
            </div>`;
          return;
        }

        // parcours chaque catégorie
        Object.entries(categories).forEach(([cat, list]) => {
          const section = document.createElement("div");
          section.classList.add("category-section");

          const title = document.createElement("div");
          title.classList.add("category-title");
          title.textContent = cat;
          section.appendChild(title);

          const row = document.createElement("div");
          row.classList.add("vehicles-row");

          list.forEach(name => {
            const statut = String(data[name] || "DM").toUpperCase().trim();
            const div = document.createElement("div");
            div.classList.add("vehicle", getStatusClass(statut));
            div.textContent = name;
            row.appendChild(div);
          });

          section.appendChild(row);
          container.appendChild(section);
        });
      }, err => console.error("Erreur RTDB :", err));
    }

    // Gestion du menu déroulant
    caserneSelect.addEventListener("change", () => {
      loadVehicles(caserneSelect.value);
    });

    // Initialisation au chargement
    window.addEventListener("DOMContentLoaded", () => {
      caserneSelect.value = "Ampuis";
      loadVehicles("Ampuis");
    });
  </script>
</body>
</html>
